/* DO NOT EDIT OR YOU KNOW WHAT YOU ARE DOING*/
/* DN11 Bird Configure */
/* Large Community */
/* Updated At 20250624 */

define LARGE_COMMUNITY_PROVINCE = 11000;
define LARGE_COMMUNITY_REGION = 11001;
define LARGE_COMMUNITY_COUNTRY = 11002;
define LARGE_COMMUNITY_WORLD_REGION = 11003;
define LARGE_COMMUNITY_CROSS_REGION = 11010;

define CROSS_NO = 100;
define CROSS_PROVINCE = 200;
define CROSS_REGION = 300;
define CROSS_COUNTRY = 400;
define CROSS_WORLD_REGION = 500;

define REGION_CODE_IMPOSSIABLE = 11111;

function add_server_location() {
    bgp_large_community.remove((MY_ASN, LARGE_COMMUNITY_PROVINCE...LARGE_COMMUNITY_WORLD_REGION, *))
    bgp_large_community.add((MY_ASN, LARGE_COMMUNITY_PROVINCE, MY_PROVINCE));
    bgp_large_community.add((MY_ASN, LARGE_COMMUNITY_REGION, MY_REGION));
    bgp_large_community.add((MY_ASN, LARGE_COMMUNITY_COUNTRY, MY_COUNTRY));
    bgp_large_community.add((MY_ASN, LARGE_COMMUNITY_WORLD_REGION, MY_WORLD_REGION));
}

function current_cross_type() {
    if bgp_large_community !~ [(MY_ASN, LARGE_COMMUNITY_CROSS_REGION, *)] then {
        /* DEFAULT VALUE */
        return CROSS_PROVINCE;
    }
    return filter(bgp_large_community, [(MY_ASN, LARGE_COMMUNITY_CROSS_REGION, * )]).min.data2;
}

function update_cross_type(int cross_type){
    int cur_type = current_cross_type();
    bgp_large_community.delete([(MY_ASN, LARGE_COMMUNITY_CROSS_REGION, *)]);
    if cur_type < cross_type then {
        bgp_large_community.add((MY_ASN, LARGE_COMMUNITY_CROSS_REGION, cross_type));
    }else{
        bgp_large_community.add((MY_ASN, LARGE_COMMUNITY_CROSS_REGION, cur_type));
    }
}

function update_cross(){
    /* Set Cross Type If Not Set */
    update_cross_type(CROSS_NO);

    /* Set By Geo */
    for int asn in bgp_path do {
        int int_asn = asn;
        if bgp_large_community ~ [(int_asn, LARGE_COMMUNITY_WORLD_REGION, *)] then {
            if (asn, LARGE_COMMUNITY_WORLD_REGION, MY_WORLD_REGION) !~ bgp_large_community || (asn, LARGE_COMMUNITY_WORLD_REGION, REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                update_cross_type(CROSS_WORLD_REGION);
            } else if (asn, LARGE_COMMUNITY_COUNTRY, MY_COUNTRY) !~ bgp_large_community || (asn, LARGE_COMMUNITY_COUNTRY, REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                update_cross_type(CROSS_COUNTRY);
            } else if (asn, LARGE_COMMUNITY_REGION, MY_REGION) !~ bgp_large_community || (asn, LARGE_COMMUNITY_REGION, REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                update_cross_type(CROSS_REGION);
            } else if (asn, LARGE_COMMUNITY_PROVINCE, MY_PROVINCE) !~ bgp_large_community || (asn, LARGE_COMMUNITY_PROVINCE, REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                update_cross_type(CROSS_COUNTRY);
            } else {
                update_cross_type(CROSS_NO);
            }
        }
    }
}

function set_bgp_pref() {
    case current_cross_type(){
        100: bgp_local_pref = 500;
        200: bgp_local_pref = 400;
        300: bgp_local_pref = 300;
        400: bgp_local_pref = 200;
        500: bgp_local_pref = 100;
        else: bgp_local_pref = 400;
    }
}
