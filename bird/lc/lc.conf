/* DO NOT EDIT OR YOU KNOW WHAT YOU ARE DOING*/
/* DN11 Bird Configure */
/* Large Community */
/* Updated At 20250624 */

define DN11_LARGE_COMMUNITY_PROVINCE = 11000;
define DN11_LARGE_COMMUNITY_REGION = 11001;
define DN11_LARGE_COMMUNITY_COUNTRY = 11002;
define DN11_LARGE_COMMUNITY_WORLD_REGION = 11003;
define DN11_LARGE_COMMUNITY_CROSS_REGION = 11010;

define DN11_CROSS_NO = 100;
define DN11_CROSS_PROVINCE = 200;
define DN11_CROSS_REGION = 300;
define DN11_CROSS_COUNTRY = 400;
define DN11_CROSS_WORLD_REGION = 500;

define DN11_REGION_CODE_IMPOSSIABLE = 11111;

function dn11_add_server_location() {
    bgp_large_community.delete([(DN11_ASN, DN11_LARGE_COMMUNITY_PROVINCE..DN11_LARGE_COMMUNITY_WORLD_REGION, *)]);
    bgp_large_community.add((DN11_ASN, DN11_LARGE_COMMUNITY_PROVINCE, DN11_PROVINCE));
    bgp_large_community.add((DN11_ASN, DN11_LARGE_COMMUNITY_REGION, DN11_REGION));
    bgp_large_community.add((DN11_ASN, DN11_LARGE_COMMUNITY_COUNTRY, DN11_COUNTRY));
    bgp_large_community.add((DN11_ASN, DN11_LARGE_COMMUNITY_WORLD_REGION, DN11_WORLD_REGION));
}

function dn11_current_cross_type() {
    if bgp_large_community !~ [(DN11_ASN, DN11_LARGE_COMMUNITY_CROSS_REGION, *)] then {
        /* DEFAULT VALUE */
        return DN11_CROSS_NO;
    }
    return filter(bgp_large_community, [(DN11_ASN, DN11_LARGE_COMMUNITY_CROSS_REGION, * )]).min.data2;
}

function dn11_update_cross_type(int cross_type){
    int cur_type = dn11_current_cross_type();
    bgp_large_community.delete([(DN11_ASN, DN11_LARGE_COMMUNITY_CROSS_REGION, *)]);
    if cur_type < cross_type then {
        bgp_large_community.add((DN11_ASN, DN11_LARGE_COMMUNITY_CROSS_REGION, cross_type));
    }else{
        bgp_large_community.add((DN11_ASN, DN11_LARGE_COMMUNITY_CROSS_REGION, cur_type));
    }
}

function dn11_update_cross(){
    /* Set Cross Type If Not Set */
    dn11_update_cross_type(DN11_CROSS_NO);

    /* Set By Geo */
    for int asn in bgp_path do {
        int int_asn = asn;
        if bgp_large_community ~ [(int_asn, DN11_LARGE_COMMUNITY_WORLD_REGION, *)] then {
            if (asn, DN11_LARGE_COMMUNITY_WORLD_REGION, DN11_WORLD_REGION) !~ bgp_large_community || (asn, DN11_LARGE_COMMUNITY_WORLD_REGION, DN11_REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                dn11_update_cross_type(DN11_CROSS_WORLD_REGION);
            } else if (asn, DN11_LARGE_COMMUNITY_COUNTRY, DN11_COUNTRY) !~ bgp_large_community || (asn, DN11_LARGE_COMMUNITY_COUNTRY, DN11_REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                dn11_update_cross_type(DN11_CROSS_COUNTRY);
            } else if (asn, DN11_LARGE_COMMUNITY_REGION, DN11_REGION) !~ bgp_large_community || (asn, DN11_LARGE_COMMUNITY_REGION, DN11_REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                dn11_update_cross_type(DN11_CROSS_REGION);
            } else if (asn, DN11_LARGE_COMMUNITY_PROVINCE, DN11_PROVINCE) !~ bgp_large_community || (asn, DN11_LARGE_COMMUNITY_PROVINCE, DN11_REGION_CODE_IMPOSSIABLE) ~ bgp_large_community then {
                dn11_update_cross_type(DN11_CROSS_COUNTRY);
            } else {
                dn11_update_cross_type(DN11_CROSS_NO);
            }
        }
    }
}

function dn11_set_bgp_pref() {
    case dn11_current_cross_type(){
        100: bgp_local_pref = 500;
        200: bgp_local_pref = 400;
        300: bgp_local_pref = 300;
        400: bgp_local_pref = 200;
        500: bgp_local_pref = 100;
        else: bgp_local_pref = 400;
    }
}
